<aside
  class="empty-space-alloc"
  aria-hidden="true"
  [style.width.px]="graphWidth * (stateService.zoom | async)!"
  [style.height.px]="graphHeight * (stateService.zoom | async)!"
></aside>
<figure
  #dagWrapper
  zoomingLayer
  [features]="features"
  [zoomStepConfig]="zoomStepConfig"
  [lastResizeEv]="lastResizeEv"
  [graphX]="graphX"
  [graphY]="graphY"
  (windowPan)="windowPan($event)"
  (freeWindowPan)="freeWindowPan($event)"
  (handleResizeSync)="handleResizeSync($event)"
  monitorResize
  (resize)="handleResizeWithEvent($event)"
  (zoomChange)="zoomChange.next($event)"
  (scroll)="(dagWrapper.scrollLeft || dagWrapper.scrollTop) && dagWrapper.scrollTo(0, 0)"
  [style.background-color]="themeConfig.background?.color"
  class="dag-wrapper"
>
  <svg class="background-grid" aria-hidden="true">
    <defs>
      <!-- Grid definition -->
      <pattern [id]="getGridPatternUniqueId()"
        [attr.width]="themeConfig.background?.dots?.width || 8"
        [attr.height]="themeConfig.background?.dots?.height  || 8"
        patternUnits="userSpaceOnUse">
        <circle
          [attr.cx]="themeConfig.background?.dots?.cx || 1"
          [attr.cy]="themeConfig.background?.dots?.cy || 1"
          [attr.r]="themeConfig.background?.dots?.radius || 1"
          [attr.fill]="themeConfig.background?.dots?.fill || '#e0e0e0'"
        />
      </pattern>
    </defs>
    <rect width="100%" height="100%" [attr.fill]="getGridPatternUrl()" />
  </svg>
  <aside
    class="panning-slider"
    [class.debug]="features.debugPanningLayer"
    aria-hidden="true"
    cdkDrag
    [cdkDragFreeDragPosition]="graphResetPan"
    [style.width.px]="lastResizeEv.width || graphWidth * (stateService.zoom | async)!"
    [style.height.px]="lastResizeEv.height || graphHeight * (stateService.zoom | async)!"
    (cdkDragMoved)="graphPan('move', $event)"
    (cdkDragStarted)="graphPan('start', $event)"
    (cdkDragEnded)="graphPan('end', $event)"
  ></aside>
  <section>
    <ai-dag-raw
      #rootDag
      class="root-dag"
      style.transform="translate({{ graphX }}px, {{ graphY }}px) scale({{ (stateService.zoom | async)! }}) "
      [noEmptySpaceAlloc]="true"
      [class.panning]="graphPanning"
      [sizeConfig]="sizeConfig"
      [nodes]="nodes"
      [edges]="edges"
      [groups]="groups"
      [hoveredEdge]="hoveredEdge"
      (graphResize)="resizeGraph($event)"
      (focusin)="focusElementFiltered($event)"
      (mousedown)="mousedown = true"
      (mouseup)="mousedown = false"
      (mouseleave)="mousedown = false"
      [class.animate-movement]="animateMove && !graphPanning"
      [resolveReference]="resolveReference"
    />
  </section>
</figure>
<div class="side-flex">
  <minimap
    #minimap
    *ngIf="enableMinimap && rootDagInitialized && lastResizeEv.width"
    [position]="minimapPosition"
    [features]="features"
    [groups]="groups"
    [nodes]="nodes"
    [customMinimapNodeTemplates]="customMinimapNodeTemplates"
    [selectedNode]="selectedNode"
    [graphPanning]="graphPanning"
    [sizeConfig]="sizeConfig"
    [graphWidth]="graphWidth"
    [graphHeight]="graphHeight"
    [winWidth]="lastResizeEv.width"
    [winHeight]="lastResizeEv.height"
    [x]="graphX"
    [y]="graphY"
    [outlineColor]="themeConfig.minimap?.outlineColor"
    [boxShadow]="themeConfig.minimap?.boxShadow"
    (windowPan)="windowPan($event)"
/>
<aside *ngIf="!!sidebarRef"
  class="sidebar-wrapper"
>
  <ng-content select="ai-dag-sidebar" [class.panning]="graphPanning"></ng-content>
</aside>
</div>
<div
  class="loading-screen"
  [class.loading]="loading || (!rootDagInitialized && showLoadingUntilGraphRendered)"
  [attr.aria-hidden]="!(loading || (!rootDagInitialized && showLoadingUntilGraphRendered))"
  >
  <mat-spinner
    [diameter]="30"
    color="primary"
    aria-label="Loading graph"
    i18n-aria-label="Label on progress spinner when the graph is loading"
  />
</div>
